# 企业级RAG系统 - 架构与功能介绍

## 📋 项目简介

**企业级RAG系统**（Enterprise RAG System）是一个基于百度千帆大模型和Milvus向量数据库的企业知识管理与智能问答平台。系统支持多种文档格式上传、智能语义检索和长期记忆管理，适用于企业知识库、客户服务、智能问答等场景。

**作者**: 李祯（小龙龙AI工作室）
**版本**: 1.0.0
**GitHub**: https://github.com/lizhen-jack/enterprise-rag-system

---

## 🎯 核心功能

### 1. 文档管理
- **多格式支持**: PDF、DOCX、TXT、MD、XLSX、XLS
- **自动解析**: 智能提取文档内容
- **智能分块**: 按段落和语义自动切分文本
- **实时索引**: 自动建立向量索引
- **元数据管理**: 文件大小、字符数、分块数统计

### 2. 语义检索（RAG）
- **向量搜索**: 基于Milvus的高性能语义检索
- **相关度排序**: COSINE相似度排序
- **来源追溯**: 显示具体文档和段落
- **多文档过滤**: 支持按文档ID范围检索

### 3. 智能对话
- **多轮对话**: 维护对话上下文
- **RAG增强**: 结合文档检索结果生成回答
- **来源引用**: 自动标注信息来源
- **个性化提示**: 支持用户自定义提示

### 4. 长期记忆（借鉴OpenClaw方法论）
- **重要性评分**（0-1）
- **分类管理**: general、user_pref、project、work
- **标签系统**: 多维度标签过滤
- **自动过期清理**: 根据重要性设置过期时间
- **访问统计**: 跟踪记忆使用频率

### 5. 用户管理
- **注册/登录**
- **JWT认证**
- **数据隔离**: 用户数据完全隔离
- **权限控制**: 细粒度权限管理

---

## 🏗️ 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Vue 3)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │  文档管理 │ │  智能对话 │ │  长期记忆 │ │  用户设置 │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
└──────────────────────────────┬──────────────────────────────┘
                               │
                        HTTP/REST API
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                  API网关 (FastAPI + Uvicorn)                 │
│  ┌────────────────────────────────────────────────────┐      │
│  │  认证中间件 (JWT)  │  CORS  │  请求限流  │  日志     │      │
│  └────────────────────────────────────────────────────┘      │
└──────────────────────────────┬──────────────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
┌───────▼───────┐      ┌──────▼──────┐      ┌───────▼────────┐
│   文档服务     │      │   RAG服务    │      │   记忆服务      │
│               │      │              │      │                │
│ • 文件上传     │      │ • 文档索引   │      │ • 记忆存储      │
│ • 格式解析     │      │ • 语义检索   │      │ • 分类管理      │
│ • 文本分块     │      │ • 上下文构建 │      │ • 过期清理      │
└───────┬───────┘      └──────┬──────┘      └───────┬────────┘
        │                      │                      │
        └──────────────────────┼──────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
┌───────▼───────┐      ┌──────▼──────┐      ┌───────▼────────┐
│  PostgreSQL   │      │   Milvus    │      │     Redis      │
│               │      │             │      │                │
│ • 用户数据    │      │ • 向量存储   │      │ • 缓存         │
│ • 文档元数据  │      │ • 相似度搜索 │      │ • 任务队列     │
│ • 对话历史    │      │ • IVF索引   │      │ • 会话管理     │
└───────────────┘      └─────────────┘      └────────────────┘



        ┌────────────────────────┐
        │   百度千帆大模型API      │
        │                         │
        │ • 嵌入模型(embedding)    │
        │ • 对话模型(ernie-speed)  │
        └────────────────────────┘
```

### 技术栈

#### 后端技术栈
| 技术 | 版本 | 用途 |
|------|------|------|
| **FastAPI** | 0.109.0 | 现代异步Web框架 |
| **Uvicorn** | 0.27.0 | ASGI服务器 |
| **SQLAlchemy** | 2.0.25 | ORM框架 |
| **AsyncPG** | 0.29.0 | PostgreSQL异步驱动 |
| **PyMilvus** | 2.3.6 | Milvus向量数据库客户端 |
| **Redis** | 5.0.1 | 缓存和任务队列 |
| **LangChain** | 0.1.5 | AI应用框架 |
| **PyMuPDF** | 1.23.8 | PDF解析 |
| **python-docx** | 1.1.0 | Word文档解析 |
| **openpyxl** | 3.1.2 | Excel文档解析 |
| **PyJWT** | 2.7.0 | JWT认证 |

#### 前端技术栈
| 技术 | 版本 | 用途 |
|------|------|------|
| **Vue 3** | 3.4 | 前端框架 |
| **Vite** | 5.0 | 构建工具 |
| **Element Plus** | 2.5 | UI组件库 |
| **Pinia** | 2.1 | 状态管理 |
| **Axios** | 1.6 | HTTP客户端 |
| **Vue Router** | 4.2 | 路由管理 |

#### 基础设施
| 技术 | 版本 | 用途 |
|------|------|------|
| **PostgreSQL** | 15 | 关系型数据库 |
| **Milvus** | 2.3.3 | 向量数据库 |
| **Redis** | 7 | 缓存和消息队列 |
| **Nginx** | Alpine | Web服务器 |
| **Docker** | 最新 | 容器编排 |
| **Docker Compose** | 3.8 | 服务编排 |

---

## 📊 数据库设计

### PostgreSQL表结构

#### Users（用户表）
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Documents（文档表）
```sql
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100),
    file_hash VARCHAR(64) UNIQUE,
    status VARCHAR(20) DEFAULT 'processing',
    chunk_count INTEGER DEFAULT 0,
    total_chars INTEGER DEFAULT 0,
    summary TEXT,
    processed_at TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Conversations（对话表）
```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    title VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Messages（消息表）
```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    conversation_id INTEGER REFERENCES conversations(id),
    role VARCHAR(10) NOT NULL,  -- user / assistant
    content TEXT NOT NULL,
    sources JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Memories（长期记忆表）
```sql
CREATE TABLE memories (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    content TEXT NOT NULL,
    importance FLOAT DEFAULT 0.5,
    category VARCHAR(50),
    tags JSONB,
    source VARCHAR(50) DEFAULT 'manual',
    is_active BOOLEAN DEFAULT TRUE,
    access_count INTEGER DEFAULT 0,
    last_accessed TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Milvus集合结构

```python
{
    "name": "enterprise_rag",
    "fields": [
        {"name": "id", "type": "INT64", "primary_key": True, "auto_id": True},
        {"name": "chunk_id", "type": "INT64"},
        {"name": "user_id", "type": "INT64"},
        {"name": "document_id", "type": "INT64"},
        {"name": "file_name", "type": "VARCHAR", "max_length": 255},
        {"name": "content", "type": "VARCHAR", "max_length": 65535},
        {"name": "embedding", "type": "FLOAT_VECTOR", "dim": 768},
        {"name": "created_at", "type": "VARCHAR", "max_length": 50}
    ],
    "index": {
        "type": "IVF_FLAT",
        "metric_type": "COSINE",
        "params": {"nlist": 128}
    }
}
```

---

## 🔧 核心服务实现

### RAGService（RAG核心服务）

**职责**: 文档索引、语义检索、对话生成

**关键方法**:
- `index_document()`: 将文档块和向量插入Milvus
- `search()`: 基于查询向量检索相似文档
- `chat()`: 结合检索结果和对话历史生成回复

**工作流程**:
1. 用户提交问题
2. 通过百度千帆Embedding API生成查询向量
3. 在Milvus中检索Top-K相似文档块
4. 构建上下文（检索结果 + 对话历史）
5. 通过百度千帆Chat API生成回复

### DocumentService（文档处理服务）

**职责**: 文件上传、解析、分块

**关键方法**:
- `upload_document()`: 上传文档并创建记录
- `_process_document()`: 异步处理文档（解析+索引）
- `_parse_document()`: 支持多种文档格式解析
- `_chunk_text()`: 智能文本分块

**分块策略**:
- 按段落分割（`\n\n`）
- 每个chunk不超过512字符
- Overlap 50字符
- 单句分割大段落

### MemoryService（长期记忆服务）

**职责**: 记忆存储、检索、过期清理

**设计特点**（借鉴OpenClaw）:
- **重要性评分**（0-1）：高保留，低淘汰
- **自动过期**：
  - 重要性>0.9: 180天（6个月）
  - 重要性>0.8: 90天（3个月）
  - 重要性>0.7: 30天（1个月）
  - 重要性>0.6: 7天
  - 重要性<0.6: 永不过期

- **分类体系**:
  - `general`: 通用记忆
  - `user_pref`: 用户偏好
  - `project`: 项目信息
  - `work`: 工作相关

---

## 🌐 API接口文档

### 认证相关

#### POST /api/users/register
注册新用户

**请求体**:
```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123",
  "full_name": "Test User"
}
```

**响应**:
```json
{
  "id": 1,
  "username": "testuser",
  "email": "test@example.com",
  "full_name": "Test User"
}
```

#### POST /api/users/login
用户登录

**请求体**:
```json
{
  "username": "testuser",
  "password": "password123"
}
```

**响应**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com"
  }
}
```

### 文档相关

#### POST /api/documents/upload
上传文档

**请求**: `multipart/form-data`
- `file`: 文件对象

**响应**:
```json
{
  "id": 1,
  "filename": "document.pdf",
  "status": "indexed",
  "chunk_count": 45,
  "total_chars": 12345,
  "created_at": "2024-02-23T10:00:00"
}
```

#### GET /api/documents
获取文档列表

**Query参数**:
- `status`: 过滤状态（可选）
- `limit`: 返回数量（默认100）

**响应**:
```json
{
  "documents": [
    {
      "id": 1,
      "filename": "document.pdf",
      "status": "indexed",
      "chunk_count": 45,
      "total_chars": 12345,
      "created_at": "2024-02-23T10:00:00"
    }
  ]
}
```

#### GET /api/documents/stats
获取文档统计

**响应**:
```json
{
  "total_documents": 10,
  "total_chunks": 450,
  "total_size": 52428800
}
```

#### DELETE /api/documents/{document_id}
删除文档

**响应**:
```json
{
  "message": "文档删除成功"
}
```

### 对话相关

#### POST /api/chat/chat
智能对话

**请求体**:
```json
{
  "message": "如何使用这个系统？",
  "conversation_id": null,
  "document_ids": [1, 2, 3],
  "user_prompt": "请用通俗易懂的语言回答",
  "temperature": 0.7
}
```

**响应**:
```json
{
  "message_id": 1,
  "conversation_id": 1,
  "response": "企业级RAG系统是一款智能工具...",
  "sources": [
    {
      "file_name": "使用手册.pdf",
      "content": "欢迎使用企业级RAG系统...",
      "score": 0.95
    }
  ],
  "created_at": "2024-02-23T10:30:00"
}
```

#### GET /api/chat/conversations
获取对话列表

**响应**:
```json
{
  "conversations": [
    {
      "id": 1,
      "title": "如何使用这个系统？",
      "created_at": "2024-02-23T10:00:00",
      "updated_at": "2024-02-23T10:30:00"
    }
  ]
}
```

#### GET /api/chat/conversations/{conversation_id}/messages
获取对话消息

**响应**:
```json
{
  "conversation_id": 1,
  "title": "如何使用这个系统？",
  "messages": [
    {
      "id": 1,
      "role": "user",
      "content": "如何使用这个系统？",
      "created_at": "2024-02-23T10:00:00"
    },
    {
      "id": 2,
      "role": "assistant",
      "content": "企业级RAG系统是一款智能工具...",
      "sources": [...],
      "created_at": "2024-02-23T10:00:05"
    }
  ]
}
```

#### DELETE /api/chat/conversations/{conversation_id}
删除对话

**响应**:
```json
{
  "message": "对话删除成功"
}
```

### 长期记忆相关

#### POST /api/chat/memory
添加长期记忆

**请求体**:
```json
{
  "content": "用户喜欢简洁的回答风格",
  "importance": 0.85,
  "category": "user_pref",
  "tags": ["style", "preference"]
}
```

**响应**:
```json
{
  "id": 1,
  "content": "用户喜欢简洁的回答风格",
  "importance": 0.85,
  "category": "user_pref",
  "tags": ["style", "preference"],
  "expires_at": "2024-05-23T10:00:00"
}
```

#### GET /api/chat/memory
检索长期记忆

**Query参数**:
- `query`: 搜索关键词（可选）
- `category`: 分类（可选）
- `min_importance`: 最小重要性（默认0.7）
- `limit`: 返回数量（默认5）

**响应**:
```json
{
  "memories": [
    {
      "id": 1,
      "content": "用户喜欢简洁的回答风格",
      "importance": 0.85,
      "category": "user_pref",
      "tags": ["style", "preference"],
      "source": "manual",
      "access_count": 15
    }
  ]
}
```

#### DELETE /api/chat/memory/{memory_id}
删除长期记忆

**响应**:
```json
{
  "message": "记忆删除成功"
}
```

---

## 🔒 安全设计

### 认证与授权

1. **JWT Token认证**
   - Token有效期: 24小时
   - 存储位置: HTTP Authorization Header
   - 加密算法: HS256

2. **密码安全**
   - bcrypt哈希（10轮）
   - 不存储明文密码

3. **数据隔离**
   - 用户数据完全隔离
   - 文档权限验证
   - 对话权限验证

### 数据保护

1. **文件上传限制**
   - 最大50MB
   - 文件类型白名单
   - 文件哈希去重

2. **SQL注入防护**
   - SQLAlchemy ORM
   - 参数化查询

3. **CORS配置**
   - 支持的域名白名单
   - 预检请求处理

---

## 🚀 性能优化

### 向量搜索优化

1. **Milvus索引策略**
   - IVF_FLAT索引
   - nlist=128
   - COSINE相似度

2. **缓存策略**
   - Redis缓存搜索结果
   - 缓存时间: 5分钟
   - 自动过期

3. **批量处理**
   - 批量生成向量
   - 批量插入Milvus

### 数据库优化

1. **连接池**
   - AsyncPG连接池
   - 最大连接数: 10

2. **索引优化**
   - 主键索引
   - 外键索引
   - 复合索引

---

## 📈 可扩展性

### 水平扩展

1. **负载均衡**
   - Nginx反向代理
   - 多实例部署

2. **微服务拆分**
   - 文档服务独立
   - RAG服务独立
   - Memory服务独立

3. **分布式向量搜索**
   - Milvus集群模式
   - 多分片存储

### 功能扩展

1. **更多文档格式**
   - PPTX
   - 图片OCR
   - 视频转文本

2. **更多AI模型**
   - 通义千问
   - 文心一言
   - GLM系列

3. **高级特性**
   - 多租户支持
   - 权限管理
   - 审计日志
   - 数据统计仪表盘

---

## 📝 技术亮点

### 1. 国内技术栈
- 百度千帆API：国内领先的AI大模型平台
- Milvus：国产高性能向量数据库
- 全中文支持：无编码问题

### 2. OpenClaw记忆方法论
- 重要性评分机制
- 自动过期清理
- 分类和标签系统

### 3. 智能文本分块
- 按段落分割
- 语义完整性保证
- Overlap设计

### 4. Docker一键部署
- 完整的服务编排
- 数据持久化
- 快速启动

---

## 🎓 适用场景

1. **企业知识库**
   - 技术文档
   - 规章制度
   - 产品手册

2. **客户服务**
   - 智能客服
   - FAQ系统
   - 产品咨询

3. **教育机构**
   - 课程资料
   - 论文检索
   - 学习辅助

4. **研究机构**
   - 文献管理
   - 知识点检索
   - 研究协作

---

## 🔗 相关链接

- **GitHub仓库**: https://github.com/lizhen-jack/enterprise-rag-system
- **百度千帆AI**: https://cloud.baidu.com/product/wenxinworkshop
- **Milvus官方文档**: https://milvus.io/docs
- **FastAPI文档**: https://fastapi.tiangolo.com
- **Vue 3文档**: https://cn.vuejs.org

---

**文档版本**: 1.0.0
**最后更新**: 2026-02-23
**作者**: 李祯（小龙龙AI工作室）
